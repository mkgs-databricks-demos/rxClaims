# A sample job for ncpdp.

resources:
  jobs:
    ncpdp_parsing:
      name: NCPDP Pharmacy Transactions

      trigger:
        # Run this job every day, exactly one day from the last run; see https://docs.databricks.com/api/workspace/jobs/create#trigger
        periodic:
          interval: 1
          unit: DAYS

      #email_notifications:
      #  on_failure:
      #    - your_email@example.com

      parameters:
        - name: catalog_use
          default: ${var.catalog}
        - name: schema_use
          default: ${resources.schemas.ncpdp_schema.name}
        - name: bundle_target
          default: ${bundle.target}
        - name: run_set_up
          default: false
        - name: pipeline_full_refresh
          default: false 
        - name: deployment_mode
          default: ${var.deployment_mode}
        - name: run_spec_process
          default: false

      tasks:

        #####################################################
        # Set Up the Volumes and Optionally Load Sample Files
        #####################################################

        # Conditional Task to Determine if set up should be run based on job parameter value.
        - task_key: Run_Set_Up
          condition_task:
            op: EQUAL_TO
            left: "{{job.parameters.run_set_up}}"
            right: "true"
        
        # Creates the required subdirectories in the volumes for each ncpdp file type
        - task_key: Create_Sub_Directories
          depends_on:
            - task_key: Run_Set_Up
              outcome: "true"
          notebook_task:
            notebook_path: ../src/setup/00-create-sub-directories.ipynb
            source: WORKSPACE
            base_parameters:
              volume_use: "${resources.volumes.ncpdp_landing_volume.name}"
              volume_sub_path: "${var.volume_sub_path}"
              ncpdp_file_types: "${var.ncpdp_file_types}"
          max_retries: 3
          min_retry_interval_millis: 60000
          retry_on_timeout: true
          disable_auto_optimization: false
          environment_key: primary

        # Conditional determines if the target is a non-production target, and should have the sample files copied over to the subdirectories for development or testing.  
        - task_key: Not_Prod
          depends_on:
            - task_key: Create_Sub_Directories
          condition_task:
            op: NOT_EQUAL
            left: "{{job.parameters.bundle_target}}"
            right: prod
        
        # Copies the Sample Files from the fixtures folder of the repo to the sub directories of the volumes.
        - task_key: Copy_Sample_Files
          depends_on:
            - task_key: Not_Prod
              outcome: "true"
          notebook_task:
            notebook_path: ../src/setup/01-copy-sample-files-to-volume.ipynb
            source: WORKSPACE
            base_parameters:
              volume_use: "${resources.volumes.ncpdp_landing_volume.name}"
              volume_sub_path: "${var.volume_sub_path}"
              ncpdp_file_types: "${var.ncpdp_file_types}"
          max_retries: 3
          min_retry_interval_millis: 60000
          retry_on_timeout: true
          disable_auto_optimization: false
          environment_key: primary

      ################################
      # Specification Document Control
      ################################

        # Check for development mode deployments
        - task_key: Is_Development_Mode
          condition_task:
            op: EQUAL_TO
            left: "{{job.parameters.deployment_mode}}"
            right: development
        
        # Conditional on whether to run the Specification Document Parsing Process in the development environment
        - task_key: Parse_Specification_Documents
          depends_on:
            - task_key: Is_Development_Mode
              outcome: "true"
          condition_task:
            op: EQUAL_TO
            left: "{{job.parameters.run_spec_process}}"
            right: "true"

        - task_key: Ensure_Vector_Search_Endpoints
          depends_on: 
            - task_key: Parse_Specification_Documents
              outcome: "true"
          notebook_task:
            notebook_path: ../src/vector_search/00-enable-vector-search-endpoints.ipynb
            source: WORKSPACE
            base_parameters:
              workspace_url: "${workspace.host}"
              sp_secret_scope: "${resources.secret_scopes.ncpdp_vs_sp.name}"
              sp_secret_key_client_id: "client_id"
              sp_secret_key_secret: "secret"
          max_retries: 3
          min_retry_interval_millis: 60000
          retry_on_timeout: true
          disable_auto_optimization: false
          environment_key: vector_search
        
        # Download the Specification Document from the Public Internet (note that serverless egress controls must allow for this download)
        - task_key: Download_Spec_Doc
          depends_on:
            - task_key: Parse_Specification_Documents
              outcome: "true"
          notebook_task:
            notebook_path: ../src/ncpdp_spec_download/00-download-specs-to-volume.ipynb
            source: WORKSPACE
            base_parameters: 
              spec_document_url: https://ncpdp.org/NCPDP/media/pdf/Payer_Sheet_Template_1.pdf
              volume_use: "${resources.volumes.spec_documents_volume.name}"
              volume_sub_path: "${var.spec_documents_raw_sub_path}"
          max_retries: 3
          min_retry_interval_millis: 60000
          retry_on_timeout: true
          disable_auto_optimization: false
          environment_key: primary
        
        # Conditional Trigger for a Full Refresh Based on the Input Parameter Value 
        - task_key: Trigger_Full_Refresh_Specification_Pipeline
          depends_on:
            - task_key: Download_Spec_Doc
          condition_task:
            op: EQUAL_TO
            left: "{{job.parameters.pipeline_full_refresh}}"
            right: "true"

        # Spec Doc Ingestion Pipeline Full Refresh
        - task_key: Full_Refresh_Spec_Doc_Ingest_Pipeline
          depends_on:
            - task_key: Trigger_Full_Refresh_Specification_Pipeline
              outcome: "true"
          pipeline_task:
            pipeline_id: ${resources.pipelines.ncpdp_specification_document_parsing.id}
            full_refresh: true
            
        # Spec Doc Ingestion Pipeline Incremental Refresh
        - task_key: Refresh_Spec_Doc_Ingest_Pipeline
          depends_on:
            - task_key: Trigger_Full_Refresh_Specification_Pipeline
              outcome: "false"
          pipeline_task:
            pipeline_id: ${resources.pipelines.ncpdp_specification_document_parsing.id}
            full_refresh: false

        # Temp: Use a SQL Notebook for ai_parse_document (not available in current/preview channels of LSDP runtime at time of authoring)
        - task_key: temp_ai_parse_document_sql
          depends_on:
            - task_key: Refresh_Spec_Doc_Ingest_Pipeline
            - task_key: Full_Refresh_Spec_Doc_Ingest_Pipeline
          run_if: AT_LEAST_ONE_SUCCESS
          sql_task:
            # file:
            #   path: ../src/ncpdp_specifications/ai_parse_document/parse_documents_v2.dbquery.ipynb
            #   source: WORKSPACE
            query:
              query_id: db4749c0-e785-4262-af3d-45e5b16c4b8b
            warehouse_id: ${resources.sql_warehouses.ncpdp_sql_warehouse.id}
            parameters: 
              destinationTableName: "specification_documents_parsed"
              limit: "100"
              partitionCount: "4"
              sourceTableName: "specification_documents"

        - task_key: Create_or_Sync_Vector_Search_Index_Initial
          depends_on: 
            - task_key: Ensure_Vector_Search_Endpoints
            - task_key: temp_ai_parse_document_sql
          notebook_task:
            notebook_path: ../src/vector_search/01-create-vector-index.ipynb
            source: WORKSPACE
            base_parameters:
              workspace_url: "${workspace.host}"
              sp_secret_scope: "${resources.secret_scopes.ncpdp_vs_sp.name}"
              sp_secret_key_client_id: "client_id"
              sp_secret_key_secret: "secret"
              vector_search_endpoint: ncpdp-specifications-vs-endpoint
              embedding_model: ${var.embedding_model}
              source_table: "specification_documents_parsed"
          max_retries: 3
          min_retry_interval_millis: 60000
          retry_on_timeout: true
          disable_auto_optimization: false
          environment_key: vector_search

        
      ##############################
      # Primary ETL Pipeline Control
      ##############################

        # Conditional Trigger for a Full Refresh Based on the Input Parameter Value 
        - task_key: Trigger_Full_Refresh
          depends_on:
            - task_key: Copy_Sample_Files
            - task_key: Run_Set_Up
              outcome: "false"
            - task_key: Not_Prod
              outcome: "false"
          run_if: AT_LEAST_ONE_SUCCESS
          condition_task:
            op: EQUAL_TO
            left: "{{job.parameters.pipeline_full_refresh}}"
            right: "true"

        # ETL Pipeline Full Refresh
        - task_key: Full_Refresh_Pipeline
          depends_on:
            - task_key: Trigger_Full_Refresh
              outcome: "true"
          pipeline_task:
            pipeline_id: ${resources.pipelines.ncpdp_etl.id}
            full_refresh: true
            
        # ETL Pipeline Incremental Refresh
        - task_key: Refresh_Pipeline
          depends_on:
            - task_key: Trigger_Full_Refresh
              outcome: "false"
          pipeline_task:
            pipeline_id: ${resources.pipelines.ncpdp_etl.id}
            full_refresh: false
            

      environments:
        - environment_key: primary
          spec:
            environment_version: ${var.serverless_environment_version}
        - environment_key: vector_search
          spec:
            environment_version: ${var.serverless_environment_version}
            dependencies: [databricks-vectorsearch]
