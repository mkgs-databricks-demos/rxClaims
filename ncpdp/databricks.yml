# This is a Databricks asset bundle definition for ncpdp.
# See https://docs.databricks.com/dev-tools/bundles/index.html for documentation.
bundle:
  name: ncpdp
  uuid: 6b809732-60d7-4af7-b6d5-5bf169857db6

include:
  - resources/*.yml
  - resources/*/*.yml

# Variable declarations. These variables are assigned in the dev/prod targets below.
variables:
  catalog:
    description: The catalog to use
  schema:
    description: The schema to use
  volume:
    description: The name of the volume to use for autoloading files
    default: landing
  volume_sub_path: 
    description: Sub directory in the volume where the NCPDP files will be autoloaded from, if applicable, with a slash to start and no trailing slash. E.g. /dir1/dir2
    default: Null
  ncpdp_file_types: 
    description: The file types that will be loaded into tables as a string of comma separated values.  Each file type should be placed in its respective directory either at the volume level, or in the volume sub path level.  The directories and the values in the string much match.  E.g. ClaimBilling, ClaimRebill, ClaimReversal
    default: ClaimBilling
  event_log_catalog:
    description: The catalog to publish the ETL Pipeline's event log.
  event_log_schema:
    description: The schema to publish the ETL Pipeline's event log. 
  serverless_environment_version: 
    default: "4"
    description: The Serverless Environment version to use with serverless workflows.  
  run_as_user:
    default: "matthew.giglia@databricks.com"
    description: The principal the workflow and pipelines should run as.  

targets:
  dev:
    # The default target uses 'mode: development' to create a development copy.
    # - Deployed resources get prefixed with '[dev my_user_name]'
    # - Any job schedules and triggers are paused by default.
    # See also https://docs.databricks.com/dev-tools/bundles/deployment-modes.html.
    mode: development
    default: true
    workspace:
      host: https://dbc-e5684c0a-20fa.cloud.databricks.com
    variables:
      catalog: dev
      schema: ncpdp_rx
      volume: landing
      volume_sub_path: Null
      ncpdp_file_types: ClaimBilling
      serverless_environment_version: "4"
      event_log_catalog: ${var.catalog}
      event_log_schema: ${resources.schemas.ncpdp_schema.name}


  prod:
    mode: production
    workspace:
      host: https://dbc-e5684c0a-20fa.cloud.databricks.com
      # We explicitly deploy to /Workspace/Users/${var.run_as_user} to make sure we only have a single copy. 
      root_path: /Workspace/Users/${var.run_as_user}/.bundle/${bundle.name}/${bundle.target}
    variables:
      catalog: prod
      schema: ncpdp_rx
      volume: landing
      volume_sub_path: Null
      ncpdp_file_types: ClaimBilling
      serverless_environment_version: "4"
      event_log_catalog: ${var.catalog}
      event_log_schema: ${resources.schemas.ncpdp_schema.name}
      run_as_user: matthew.giglia@databricks.com
    permissions:
      - user_name: ${var.run_as_user}
        level: CAN_MANAGE
